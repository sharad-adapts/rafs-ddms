# RAFSDDMS production deployment

## [Cloud Agnostic] Build image

**WARNING:** It is recommended to use the [Dockerfile](../../Dockerfile) image for production systems.  The [Dockerfile.tests](../../Dockerfile.tests) image, contains extra dependencies needed for testing purposes and is not intended for production use.

```shell
docker build --file ./Dockerfile -t rafsddms:latest .
```

## Cloud specific

### Azure

* [Azure deployment instructions](./azure/)
* [Azure monitoring local setup](./azure/monitoring/)

## Register service

Register service it is used for ddms visibility, in rafs-ddms mvp1 CICD will register the latest specs in each register service environment. More documentation on how to implement this in [register docs](../docs/register/).

## Recommended NFRs

We onboarded RAFS on release/0.20 (M18) on azure, since then, we have noticed the following on infrastructure regards.

### Compatibility and Portability

RAFS contains tiny specific csp layer:

* Metrics - prometheus for azure.
  * As Azure uses prometheus as prefered gathering and metric tool, it is implemented for azure only, however, it is not mandatory for other CSP's.
* AzureBlobHandler - handle upload and downloads to the azure container storage account with pre-signed url generated by dataset service.
  * This can be replaced with the standard http request handlers (PUT/GET), these should be compatible with any CSP's however, it is recommended to use the CSP's libraries (blob lib for azure), probably (boto - s3) for other CSP's as it is compatible with minio as well as with S3.
* **Redis** - optional - not mandatory, uses regular redis connection parameters (no csp specific).

**NOTE: Distroless dockerfile compatibility** - RAFS project borned with the higher security standards, we developed distroless dockerfile definition, which uses the `msosdu` registry as public registry to get the distroless and python images, nonetheless, this public image it is not CSP's specific, only to avoid using external (and some times unavailable) registries such as `cgr.dev/chainguard/` or to prevent hitting the download limit from `docker.io`.

### Resiliency and Availability

* RAFS generate lots of requests to storage, schema and search services for schema and reference data validation.
  * If **policy service** it is enabled, it is recommended to increase the availability of the entitlements services as this is highly used by policy service as well as legal. We had noticed that by using entitlements separated service helps to aleviate the delay/load in policy service.
  * [Uviloop](https://www.uvicorn.org/#quickstart) it is intended to increase the performance and lower the pod resources consumption, however, we hadn't measure this yet.
* Integration tests can be executed in `auto` mode, nevertheless this will generate large ammount of async request to core services (mostly storage service). If storage backend it is not configured correctly it might fail randomly.
  * To overcome this in azure side, we increased the CosmosDB throughput (for storage and entitlements).
  * We needed to scale vertically storage service.
  * Needed to increase replicas at AGIC.
  * Improved the policy service docker image for azure.

### Monitoring

* RAFS can use out of the box monitoring controllers, in azure implementation we decided to onboard FastApi Prometheus controller to gather metrics, more information can be found on the [prometheus use-case implementation](../devops/azure/monitoring/)
* The monitoring layer it can be configured per provider, to use whichever driver that it is more convenient for specific CSP. [app/providers/helpers/metrics](../app/providers/helpers/metric.py).

#### Readiness feature

RAFS uses an `SERVICE_READINESS_URLS` env var to define services that are dependencies of rafs ddms like storage or schema service, see [#338](https://community.opengroup.org/osdu/platform/domain-data-mgmt-services/rock-and-fluid-sample/rafs-ddms-services/-/issues/338) for reference, put the needed url liveness/readiness services to be checked separated by coma.

In Example:

```shell
SERVICE_READINESS_URLS="http://storage/api/storage/v2/liveness_check,http://schema/api/schema-service/v1/liveness_check"
```

**NOTE** This is an optional feature, omit setting up `SERVICE_READINESS_URLS` env var if don't need to use it at all.

### Security

* Leveraged authentication and authorization to the istio envoy CSP specific implementation.
* RAFS does not require any additional or privileged service accounts, it will proxy the access_token as it is to the proper OSDU core services.
* [Optional] Azure implementation disables auth in swagger endpoints.
* Distroless production ready docker image [Dockerfile](../Dockerfile)
